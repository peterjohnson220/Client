<h2 class="text-center">Peer Exchange Jobs</h2>
<div class="filters position-relative d-flex mt-2 mb-2">
  <div>
    <i class="fas fa-search position-absolute"></i>
    <pf-input-debounce 
      [id]="'exchange-jobs-search-box'"
      [delay]="400"
      [(ngModel)]="searchTerm"
      [ngModelOptions]="{standalone: true}"
      [placeholderText]="'Search job title'"
      (valueChanged)="handleSearchFilterChanged($event)"
    >
    </pf-input-debounce>
  </div>
  <div class="ml-3">
    <pf-multi-select
      [labelText]="'Job Family'"
      [options]="jobFamilyFilterOptions$ | async"
      [selectedOptionNames$]="selectedJobFamilyOptionNames$"
      [isExpanded$]="isJobFamilyFilterExpanded$"
      [isLoading$]="isJobFamilyFilterLoading$"
      pfClickElsewhere
      [whitelist]="[]"
      (clickElsewhere)="handleJobFamilyToggle(false)"
      (selectFacadeClick)="handleJobFamilyToggle()"
      (checkboxClick)="handleJobFamilyCheckboxToggle($event)"
      (clearSelectionsClick)="handleJobFamilyClearSelections()"
    >
    </pf-multi-select>
  </div>
</div>

<div>
  <label class="text-uppercase" data-qa-id="lbl-exchange-jobs-total">
    peer exchange jobs: {{ totalPeerExchangeJobs$ | async }} total
  </label>
  <button class="view-button ml-2"
          title="Grid View" 
          [ngClass]="{'view-button-active' : isListView}" 
          (click)="toggleViewType(true)">
    <i class="fas fa-table"></i>
  </button>
  <button class="view-button" 
          title="Detail View" 
          [ngClass]="{'view-button-active' : !isListView}" 
          (click)="toggleViewType(false)">
    <i class="fas fa-list"></i>
  </button>
</div>

<div class="grid-container position-relative">
  <pf-async-container
    class="h-100"
    [loading]="loading$ | async"
    [loadingError]="loadingError$ | async"
    [loadingErrorMessage]="'Error loading exchange jobs'"
    (reload)="reload()"
  >
      <ng-template [ngIf]="isListView">
        <div
                class="k-tooltip-container"
                kendoTooltip
                showOn="none"
                [tooltipTemplate]="template"
                filter=".k-grid td"
                (mouseover)="showExchangeTitleTooltip($event)"
        >
          <pf-grid-detail-panel
            [isExpanded$]="isDetailPanelExpanded$"
            [jobId]="selectedExchangeJob.ExchangeJobId"
            [jobTitle]="selectedExchangeJob.ExchangeJobTitle"
            [jobDescription]="selectedExchangeJob.ExchangeJobDescription"
            [jobFamily]="selectedExchangeJob.ExchangeJobFamily"
            [jobExchange]="selectedExchangeJob.ExchangeName"
            (closeClick)="handleCloseDetailPanel()"        
          ></pf-grid-detail-panel>
          <kendo-grid
                [data]="exchangeJobs$ | async"
                [style.height.%]="100"
                [pageSize]="(gridState$ | async)?.take"
                [skip]="(gridState$ | async)?.skip"
                [sort]="(gridState$ | async)?.sort"
                [filter]="(gridState$ | async)?.filter"
                [resizable]="true"
                [sortable]="true"
                [pageable]="{ buttonCount: 5, info: true }"
                (dataStateChange)="handleDataStateChange($event)"
                (detailExpand)="handleDetailExpand($event)"
          >
          <kendo-grid-column [resizable]="false" [width]="40">
            <ng-template kendoGridCellTemplate let-dataItem>
              <button class="associate-button"
                      [disabled]="!isAssociable(dataItem.ExchangeId, dataItem.ExchangeJobId)"
                      (click)="handleAssociateClick(dataItem.ExchangeId, dataItem.ExchangeJobId)">
                <i class="fas fa-exchange-alt"></i>
              </button>
            </ng-template>
          </kendo-grid-column>
          <kendo-grid-column  field="ExchangeJobTitle" title="Job Title">
            <ng-template kendoGridCellTemplate let-dataItem>
              <a id="{{'exchange-title-'+ dataItem.ExchangeId + '-' + dataItem.ExchangeJobId}}"
                  href="javascript:void(0)" 
                  (click)="handleExchangeJobClick(dataItem)" 
                  class="grid-link exchange-job-title"
                  [class.selected]="dataItem.Id === selectedExchangeJob.Id && (isDetailPanelExpanded$ | async)">
                  <div [innerHTML]="dataItem.ExchangeJobTitle | highlightText: searchTerm"></div>
              </a>
            </ng-template>
          </kendo-grid-column>
          <kendo-grid-column field="ExchangeJobFamily" title="Job Family">
            <ng-template kendoGridCellTemplate let-dataItem>
              <span *ngIf="dataItem.ExchangeJobFamily; else noFamily">{{ dataItem.ExchangeJobFamily }}</span>
              <ng-template #noFamily>
                <span>No Family</span>
              </ng-template>
            </ng-template>
          </kendo-grid-column>
          <kendo-grid-column field="ExchangeName" title="Exchange Name"></kendo-grid-column>
          <ng-template kendoGridDetailTemplate let-dataItem>
            <pf-peer-job-association-associated-jobs
                    [companyJobs]="getCompanyJobAssociations(dataItem.ExchangeId, dataItem.ExchangeJobId)"
                    (removeAssociation)="handleRemoveAssociateClick(
                        dataItem.ExchangeId,
                        dataItem.ExchangeJobId,
                        $event)">
            </pf-peer-job-association-associated-jobs>
          </ng-template>
          <ng-template kendoGridNoRecordsTemplate>
            No results based on your search.
            <a href="javascript:void(0)" (click)="reload(true)">
              <i class="fas fa-redo-alt"></i>Reset now
            </a>
          </ng-template>
        </kendo-grid>
        </div>
      </ng-template>

      <ng-template [ngIf]="!isListView">
        <kendo-grid
                [data]="exchangeJobs$ | async"
                [style.height.%]="100"
                [pageSize]="(gridState$ | async)?.take"
                [skip]="(gridState$ | async)?.skip"
                [sort]="(gridState$ | async)?.sort"
                [filter]="(gridState$ | async)?.filter"
                [resizable]="true"
                [sortable]="true"
                [pageable]="{ buttonCount: 5, info: true }"
                (dataStateChange)="handleDataStateChange($event)"
        >
          <kendo-grid-span-column>
            <kendo-grid-column
                    field="ExchangeJobTitle"
                    title="Job Title"
                    >
            </kendo-grid-column>
            <kendo-grid-column
                    field="ExchangeJobFamily"
                    title="Job Family"
                    >
            </kendo-grid-column>
            <kendo-grid-column
                    field="ExchangeName"
                    title="Exchange"
                    >
            </kendo-grid-column>
            <ng-template kendoGridCellTemplate let-dataItem>
              <h4 class="d-inline" [innerHTML]="dataItem.ExchangeJobTitle | highlightText: searchTerm"></h4>
              <button [attr.disabled]="!isAssociable(dataItem.ExchangeId, dataItem.ExchangeJobId) ? true : null"
                      (click)="handleAssociateClick(dataItem.ExchangeId, dataItem.ExchangeJobId)"
                      class="associate-button float-right">
                <i class="fas fa-exchange-alt"></i>
              </button>

              <h6 class="clear">
                <strong>Family:</strong> {{dataItem.ExchangeJobFamily}} |
                <strong>Exchange: </strong>{{dataItem.ExchangeName}}
              </h6>

              <br />

              <pf-peer-job-association-associated-jobs
                      [companyJobs]="getCompanyJobAssociations(dataItem.ExchangeId, dataItem.ExchangeJobId)"
                      (removeAssociation)="handleRemoveAssociateClick(
                          dataItem.ExchangeId,
                          dataItem.ExchangeJobId,
                          $event)">
              </pf-peer-job-association-associated-jobs>

              <br />

              <div class="job-description">
                <h4>Job Description</h4>
                <p *ngIf="dataItem.ExchangeJobDescription" [innerHTML]="dataItem.ExchangeJobDescription | jobDescriptionParser"></p>
                <p class="font-italic" *ngIf="!dataItem.ExchangeJobDescription">No Job Description Available</p>
              </div>
            </ng-template>
          </kendo-grid-span-column>

          <ng-template kendoGridNoRecordsTemplate>
            No results based on your search.
            <a href="javascript:void(0)" (click)="reload(true)">
              <i class="fas fa-redo-alt"></i>Reset now
            </a>
          </ng-template>
        </kendo-grid>
      </ng-template>
  </pf-async-container>
</div>
<ng-template #template let-anchor>
  <span>{{ anchor.nativeElement.innerText }}</span>
</ng-template>
