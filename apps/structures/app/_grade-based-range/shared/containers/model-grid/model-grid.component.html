<pf-data-grid
  [title]="(metaData$ | async)?.IsCurrent ? (metaData$ | async)?.StructureName : (metaData$ | async)?.ModelName"
  [subtitle]="(metaData$ | async)?.IsCurrent ? '' : 'Structure: ' + (metaData$ | async)?.StructureName"
  [navigationURL]="hasStructuresPageFlagEnabled ? '/client/structures' : '/marketdata/structures.asp'"
  [inboundFilters]="inboundFilters"
  [defaultSort]="defaultSort"
  [pageViewId]="modelGridPageViewId"
  [subHeaderTemplate]="subHeaderTemplate"
  [pagingOptions]="defaultPagingOptions"
  [columnTemplates]="colTemplates"
  [noRecordsFound]="'No grades found.'"
  [applyDefaultFilters]="false"
  [actionBarConfig]="fullGridActionBarConfig"
  [pageTheme]="pfThemeType.NextGen"
  [contentClassNamesOverrides]="'py-3 px-4'"
  [borders]="false"
  [gridContainerSplitViewWidth]="'60%'"
  [showSplitViewToggle]="showHorizontalChart ? false : true"
  [splitViewTemplate]="showHorizontalChart ? null : verticalGraph"
  [syncScrollWithSplit]="showHorizontalChart ? false : true"
  [splitOnSelection]="false"
  [reorderable]="reorderable"
  [gridRowActionsConfig]="(metaData$ | async)?.IsCurrent ? null: gridRowActionsConfig"
  [gridActionsTemplate]="gridActions"
  [gridActionsRightTemplate]="gridActionsRightTemplate"
  [saveSort]="saveSort"
  [modifiedKey]="modifiedKey"
  [allowMultipleSort]="allowMultipleSort"
  [gridConfig]="gridConfig"
  [pageable]="!gridConfig.EnableInfiniteScroll"
  [flexColumnContainerHeightAuto]="false"
  [filterPanelTemplates]="filterTemplates"
  [additionalDataForExport]="this.chartSvgs"
  [hideOverflow]="false"
>
</pf-data-grid>

<ng-template #subHeaderTemplate>
  <div class="card grade-summary-container">
    <div class="card-header" (click)="isSummaryCollapsed = !isSummaryCollapsed" [style.cursor]="'pointer'">
      <span class="title">Model Summary</span>
      <fa-icon
        class="float-right fa-lg fa-arrow-right mr-3 arrow-icon"
        [icon]="['far', isSummaryCollapsed ? 'angle-right' : 'angle-down']">
      </fa-icon>
    </div>
    <div class="card-body collapse" [ngbCollapse]="isSummaryCollapsed">
      <div class="position-relative">
        <pf-data-grid
          [pageViewId]="modelSummaryPageViewId"
          [showTitle]="false"
          [showHeaderWhenCompact]="true"
          [inboundFilters]="inboundFilters"
          [contentClassNamesOverrides]="'p-0'"
          [allowSort]="false"
          [applyDefaultFilters]="false"
          [actionBarConfig]="singleRecordActionBarConfig"
          [reorderable]="false"
          [gridConfig]="singleGridConfig"
          [columnTemplates]="colTemplates"
          [compactGridMinHeight]="'105px'"
          [flexColumnContainerHeightAuto]="true"
          [pageable]="false"
          [hideVerticalScrolling]="true">
        </pf-data-grid>

        <pf-grade-based-summary-chart></pf-grade-based-summary-chart>
      </div>
    </div>
  </div>
  <div class="card grade-vertical-chart-container" *ngIf="showHorizontalChart">
    <div class="card-header" (click)="isRangeChartCollapsed = !isRangeChartCollapsed" [style.cursor]="'pointer'">
      <span class="title">Ranges</span>
      <fa-icon
        class="float-right fa-lg fa-arrow-right mr-3 arrow-icon"
        [icon]="['far', isRangeChartCollapsed ? 'angle-right' : 'angle-down']">
      </fa-icon>
    </div>
    <div class="card-body collapse" [ngbCollapse]="isRangeChartCollapsed">
      <div class="position-relative">
        <pf-grade-based-horizontal-range-chart [isRangeChartCollapsed]="isRangeChartCollapsed"></pf-grade-based-horizontal-range-chart>
      </div>
    </div>
  </div>
  <div class="add-grade-button" *ngIf="!(metaData$ | async)?.IsCurrent">
    <button [pfSecuredResource]="permissions.STRUCTURES_CREATE_EDIT_MODEL" class="btn btn-secondary" (click)="handleAddGradeClicked()">New Grade</button>
  </div>
</ng-template>

<ng-template #noFormatting let-dataRow="dataRow" let-fieldName="fieldName">
  <div pfEllipsisActive class="ellipsis-overflowing-text-wrap" *ngIf="dataRow[fieldName]; else noValue">
    {{dataRow[fieldName]}}
  </div>
</ng-template>

<ng-template #verticalGraph>
  <pf-grade-based-vertical-range-chart></pf-grade-based-vertical-range-chart>
</ng-template>

<ng-template #noValue>
  - -
</ng-template>

<ng-template #percentage let-dataRow="dataRow" let-fieldName="fieldName">
  <ng-container *ngIf="dataRow[fieldName] || dataRow[fieldName] === 0; else noValue">{{dataRow[fieldName]}}%</ng-container>
</ng-template>

<ng-template #gridActions>
  <pf-grid-context
    [title]="'Grade Ranges'">
  </pf-grid-context>
</ng-template>

<ng-template #gridActionsRightTemplate>
  <pf-grid-context [metadata]="metaData$ | async">
      <button right-of-metadata-text-content [attr.data-qa-id]="'btn-structures-toggle-vertical-chart'"
              (click)="handleChartViewToggle()"
              class="btn btn-secondary pf-btn btn-chart-view">
        <fa-icon icon="chart-bar"></fa-icon>
        <span *ngIf="showHorizontalChart">View Vertical</span>
        <span *ngIf="!showHorizontalChart">View Horizontal</span>
      </button>
  </pf-grid-context>
</ng-template>

<ng-template #gridGlobalActions>
  <pf-global-actions
    [metadata]="metaData$ | async"
    [isNewModel]="isNewModel"
    (manageModelClicked)="handleManageModelClicked()"
    (modelSettingsClicked)="handleModelSettingsClicked()"
    (publishModelClicked)="handlePublishModelClicked()"
    (duplicateModelClicked)="handleDuplicateModelBtnClicked()">
  </pf-global-actions>
</ng-template>

<pf-grade-based-model-settings-modal
  [rangeGroupId]="rangeGroupId"
  [pageViewId]="pageViewId"
  [isNewModel]="isNewModel">
</pf-grade-based-model-settings-modal>

<ng-template #rangeField let-dataRow="dataRow" let-fieldName="fieldName" let-rowIndex="rowIndex">
  <ng-container>
    <pf-range-field-editor
      [pageViewId]="modelGridPageViewId"
      [rangeType]="rangeType"
      [rangeGroupId]="dataRow.CompanyStructures_RangeGroup_CompanyStructuresRangeGroup_ID"
      [rangeId]="dataRow.CompanyStructures_Ranges_CompanyStructuresRanges_ID"
      [rate]="(metaData$ | async)?.Rate"
      [fieldValue]="dataRow[fieldName]"
      [fieldName]="fieldName"
      [rangeRecalculationType]="rangeRecalculationType.Range"
      [currentStructure]="(metaData$ | async)?.IsCurrent"
      [dataRow]="dataRow"
      [rowIndex]="rowIndex"
      [textAlign]="'center'"
      [roundingSettings]="roundingSettings"
      [refreshRowDataViewFilter]="getRefreshFilter(dataRow)"
      [updateMetaInfo]="{ pageViewId: modelGridPageViewId }"
      [readonlyValueTemplate]="rangeValue">
    </pf-range-field-editor>
  </ng-container>
</ng-template>

<ng-template #mid let-dataRow="dataRow" let-fieldName="fieldName" let-rowIndex="rowIndex">
  <ng-container>
    <pf-range-field-editor
      [pageViewId]="modelGridPageViewId"
      [rangeType]="rangeType"
      [rangeGroupId]="dataRow.CompanyStructures_RangeGroup_CompanyStructuresRangeGroup_ID"
      [rangeId]="dataRow.CompanyStructures_Ranges_CompanyStructuresRanges_ID"
      [rate]="(metaData$ | async)?.Rate"
      [fieldValue]="dataRow.CompanyStructures_Ranges_Mid"
      [fieldName]="fieldName"
      [rangeRecalculationType]="rangeRecalculationType.Mid"
      [currentStructure]="(metaData$ | async)?.IsCurrent"
      [dataRow]="dataRow"
      [rowIndex]="rowIndex"
      [textAlign]="'center'"
      [roundingSettings]="roundingSettings"
      [refreshRowDataViewFilter]="getRefreshFilter(dataRow)"
      [updateMetaInfo]="{ pageViewId: modelGridPageViewId, metaData: metaData, dispSeq: dataRow.CompanyStructures_Ranges_DispSeq }"
      [updateSuccessCallbackFn]="updateMidSuccessCallbackFn"
      [readonlyValueTemplate]="rangeValue"
      [reloadGridData]="true">
    </pf-range-field-editor>
  </ng-container>
</ng-template>

<ng-template #eeCount let-dataRow="dataRow" let-fieldName="fieldName">
  <ng-container *ngIf="dataRow.CompanyStructures_RangeGroup_Employees_Per_Grade as numEmployees; else noValue">
    <a class="temp-link-color-override" routerLinkActive="disabled" routerLink="/grade/{{rangeGroupId}}/employees/{{dataRow.CompanyStructures_Ranges_CompanyStructuresRanges_ID}}">
      {{ numEmployees }}
    </a>
  </ng-container>
</ng-template>

<ng-template #jobsCount let-dataRow="dataRow" let-fieldName="fieldName">
  <ng-container *ngIf="dataRow.CompanyStructures_RangeGroup_Jobs_Per_Grade as numJobs; else noValue">
    <a class="temp-link-color-override" routerLinkActive="disabled" routerLink="/grade/{{rangeGroupId}}/jobs/{{dataRow.CompanyStructures_Ranges_CompanyStructuresRanges_ID}}">
      {{ numJobs }}
    </a>
  </ng-container>
</ng-template>

<ng-template #diffField let-dataRow="dataRow" let-fieldName="fieldName" let-rowIndex="rowIndex">
  <ng-container>
    <pf-range-field-editor
      [pageViewId]="modelGridPageViewId"
      [rangeType]="rangeType"
      [rangeGroupId]="dataRow.CompanyStructures_RangeGroup_CompanyStructuresRangeGroup_ID"
      [rangeId]="dataRow.CompanyStructures_Ranges_CompanyStructuresRanges_ID"
      [rate]="(metaData$ | async)?.Rate"
      [fieldValue]="dataRow[fieldName]"
      [fieldName]="fieldName"
      [rangeRecalculationType]="rangeRecalculationType.MidDiff"
      [currentStructure]="(metaData$ | async)?.IsCurrent"
      [dataRow]="dataRow"
      [rowIndex]="rowIndex"
      [textAlign]="'center'"
      [noRounding]="true"
      [refreshRowDataViewFilter]="getRefreshFilter(dataRow)"
      [updateMetaInfo]="{ pageViewId: modelGridPageViewId }"
      [readonlyValueTemplate]="rangeValue"
      [minValue]="-999999999999999"
      [maxValue]="200"
      [reloadGridData]="true">
    </pf-range-field-editor>
  </ng-container>
</ng-template>

<ng-template #rangeSpreadField let-dataRow="dataRow" let-fieldName="fieldName" let-rowIndex="rowIndex">
  <ng-container>
    <pf-range-field-editor
      [pageViewId]="modelGridPageViewId"
      [rangeType]="rangeType"
      [rangeGroupId]="dataRow.CompanyStructures_RangeGroup_CompanyStructuresRangeGroup_ID"
      [rangeId]="dataRow.CompanyStructures_Ranges_CompanyStructuresRanges_ID"
      [rate]="(metaData$ | async)?.Rate"
      [fieldValue]="dataRow[fieldName]"
      [fieldName]="fieldName"
      [rangeRecalculationType]="rangeRecalculationType.Spread"
      [currentStructure]="(metaData$ | async)?.IsCurrent"
      [dataRow]="dataRow"
      [rowIndex]="rowIndex"
      [textAlign]="'center'"
      [noRounding]="true"
      [refreshRowDataViewFilter]="getRefreshFilter(dataRow)"
      [updateMetaInfo]="{ pageViewId: modelGridPageViewId }"
      [readonlyValueTemplate]="rangeValue"
      [maxValue]="200">
    </pf-range-field-editor>
  </ng-container>
</ng-template>

<ng-template #gridRowActionsTemplate let-dataRow="dataRow" let-rowIndex="rowIndex">
  <div [pfSecuredResource]="permissions.STRUCTURES_CREATE_EDIT_MODEL">
    <button class="btn bg-transparent" (click)="openRemoveRangeModal(dataRow['CompanyStructures_Ranges_CompanyStructuresGrades_ID'])" 
            [disabled]="dataRow.CompanyStructures_RangeGroup_Jobs_Per_Grade != 0 || singleGrade" 
            title="{{ singleGrade ? 'Cannot remove the last grade from a structure model' : dataRow.CompanyStructures_RangeGroup_Jobs_Per_Grade == 0 ? 'Delete Grade' : 'Only grades with no jobs assigned to them can be deleted'}}">
      <fa-icon [icon]="['far', 'trash-alt']" ></fa-icon>
    </button>
  </div>
</ng-template>

<ng-template #rangeValue let-dataRow="dataRow" let-fieldName="fieldName">
  <ng-container *ngIf="dataRow[fieldName]; else noValue">{{ dataRow[fieldName] | rangeValue: (metaData$ | async)?.Rate }}</ng-container>
</ng-template>

<pf-modal-form
  [size]="'md'"
  [title]="'Remove a Grade'"
  [primaryButtonText]="'Remove'"
  [primaryButtonClass]="'btn-danger'"
  [primaryButtonTextSubmitting]="'Removing'"
  [modalId]="'au-modal-model-grid-remove-range'"
  [submitting]="(removingRange$ | async).loading"
  [allowDismiss]="!(removingRange$ | async).loading"
  [isOpen$]="showRemoveRangeModal$"
  (onSubmit)="removeRange()"
  (onDismiss)="showRemoveRangeModal.next(false)">

  <ng-container basic-content>
    <div class="remove-range">This grade will be removed from this structure. This will cause a recalculation of grade values. Are you sure you want to continue?</div>
    <div *ngIf="removingRange$ | async as removingRange">
      <div *ngIf="removingRange.loadingError">
        <br>
        <span class="text-danger">
          <b *ngIf="removingRange.loadingErrorResponse.status !== 200">
            We encountered a problem removing your grade. Please try again or contact your account representative.
          </b>
        </span>
      </div>
    </div>
  </ng-container>
</pf-modal-form>