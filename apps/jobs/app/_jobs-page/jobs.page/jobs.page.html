<pf-data-grid
  [pageViewId]="pageViewId"
  [titleTemplate]="titleTemplate"
  [navigationURL]="'/client/dashboard'"
  [selectionField]="'CompanyJob_ID'"
  [gridActionsTemplate]="gridActions"
  [columnTemplates]="colTemplates"
  [filterPanelTemplates]="filterTemplates"
  [inboundFilters]="filters"
  [defaultSort]="defaultSort"
  [enableSelection]="true"
  [splitViewTemplate]="jobsDetails"
  [splitViewDisplayFields]="['CompanyJobs_Job_Family']"
  [noRecordsFound]="'No jobs available. Please change your search criteria or add a new job.'"
  [actionBarConfig]="actionBarConfig"
  [gridRowActionsConfig] = "(!(selectedRecordId$ | async))? gridRowActionsConfig: null" >
</pf-data-grid>

<ng-template #gridRowActionsTemplate let-dataRow="dataRow">
  <fa-icon [icon]="['far', 'edit']"  title="Edit Job"  *ngIf="(userContext$ | async)?.CompanyId !== 1401"
           [attr.data-qa-id]="'btn-jobs-page-edit-job-' + dataRow['CompanyJobs_CompanyJob_ID']"
           [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
           (click)="toggleJobManagmentModal(true, dataRow['CompanyJobs_CompanyJob_ID'], $event)" class="pr-2" [fixedWidth]="true"></fa-icon>
  <fa-icon [icon]="['far', 'trash-alt']" title="Delete Job"
           [attr.data-qa-id]="'btn-jobs-page-delete-job-' + dataRow['CompanyJobs_CompanyJob_ID']"
           [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
           (click)="openDeleteJobModal(dataRow['CompanyJobs_CompanyJob_ID'], dataRow['CompanyJobs_Job_Title']); $event.stopPropagation()" class="pr-2" [fixedWidth]="true"></fa-icon>
</ng-template>

<ng-template #titleTemplate>
  {{(userContext$ | async)?.CompanyName + ' - Jobs'}}
  <button
    *ngIf="enablePageToggle"
    class="btn btn-secondary align-top ml-3"
    [attr.data-qa-id]="'btn-toggle-jobs-page'"
    [id]="'btn-toggle-jobs-page'"
    (click)="jobsPageToggle()">
    Back to old Jobs page
    <div *ngIf="(navigatingToOldPage$ | async).loading" class="loading-icon-container ml-2">
      <pf-loading-indicator></pf-loading-indicator>
    </div>
  </button>
</ng-template>

<ng-template #jobMatchCount let-dataRow="dataRow">
  <span  
    (click)="openSurveyParticipationModal(dataRow['CompanyJobs_PricingMatchesCount'], dataRow['CompanyJobs_CompanyJob_ID'], $event)">
   {{dataRow['CompanyJobs_PricingMatchesCount']}}
  </span>
</ng-template>

<ng-template #jobTitleColumn let-dataRow="dataRow" let-hover="hover">
  <div class="d-flex align-items-center">
    <div pfEllipsisActive class="ellipsis-overflowing-text-wrap" >{{dataRow['CompanyJobs_Job_Title']}}</div>
    <div *ngIf="dataRow['CompanyJobs_JobAttachmentCount']>0 && !(selectedRecordId$ | async)"
      data-html="true" kendoTooltip class="pl-2"
      title="{{dataRow['CompanyJobs_JobAttachmentCount']}} Attachment(s)">
      <fa-icon icon="paperclip"></fa-icon>
    </div>
    <div
      *ngIf="!(selectedRecordId$ | async)"
      [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
      class="ml-auto pl-2">
  </div>
  </div>
</ng-template>

<pf-peer-exchange-matches *ngIf="show" [offset]="offset"  [jobId]="peerJobId"></pf-peer-exchange-matches>

<ng-template #jobStatusColumn let-dataRow="dataRow">
  {{dataRow['CompanyJobs_JobStatus'] ? 'Active' : 'Inactive'}}
</ng-template>

<ng-template #hasPeerDataColumn let-dataRow="dataRow">
  <fa-icon  *ngIf="dataRow['CompanyJobs_Peer']"
    icon="exchange-alt"
    [id]="dataRow['CompanyJobs_CompanyJob_ID']"
    (click)="onToggle($event, null)"
    (mouseenter)="onToggle($event, dataRow['CompanyJobs_CompanyJob_ID'])"
    (mouseleave)="onToggle($event, null)">
  </fa-icon>
</ng-template>

<ng-template #jobsDetails let-splitViewEmitter="splitViewEmitter" let-splitViewFilters="splitViewFilters">
  <pf-jobs-details
    [jobDetailsFilters]="splitViewFilters"
    (onClose)="splitViewEmitter.emit('close')">
  </pf-jobs-details>
</ng-template>

<ng-template #gridGlobalActions>
  <button
    [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
    [attr.data-qa-id]="'btn-jobs-page-new-job'"
    type="button"
    title="Add Job"
    (click)="toggleJobManagmentModal(true)"
    class="btn btn-primary">
    New Job
  </button>

  <pf-export-list-popover
    [disableCustomExport]="!selectedPricingIds.length"
    [disabledCustomExportTooltip]="'Select a pricing'"
    [disablePopover]="disableExportPopover"
    [disabledPopoverTooltip]="'Select a Priced Job'"
    (exportEmitter)="exportPricings($event)">
  </pf-export-list-popover>
</ng-template>


<ng-template #gridActions>
  <button
    [pfSecuredResource]="permissions.MODIFY_PRICINGS"
    [disabled]="!isActiveJobs() || !selectedPricingIds.length"
    [attr.data-qa-id]="'btn-jobs-page-modify-pricings'"
    (click)="modifyPricings()"
    type="button"
    class="btn btn-secondary pf-btn-borderless">
    <fa-icon [icon]="['fal', 'file-invoice-dollar']"></fa-icon>
    Modify Pricings <span *ngIf="selectedPricingIds.length">({{selectedPricingIds.length}})</span>
  </button>
  <button
    [disabled]="!isActiveJobs() || !(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length)"
    [pfSecuredResource]="permissions.NEW_PROJECT"
    [attr.data-qa-id]="'btn-jobs-page-create-project'"
    type="button"
    (click)="openCreateProjectModal()"
    [title]="!(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length) ? 'No Jobs or Pricings Selected' : ''"
    class="btn btn-secondary pf-btn-borderless">
    <fa-icon [icon]="['far', 'calculator']"></fa-icon>
    Create Project
    <span *ngIf="selectedJobIds.length + selectedPricingIds.length + selectedJobPayMarketCombos.length > 0 && isActiveJobs()">
      ({{selectedJobIds.length + selectedPricingIds.length + selectedJobPayMarketCombos.length}})
    </span>
  </button>
  <button
    [disabled]="!(selectedJobIds.length)"
    [pfSecuredResource]="permissions.JOBS_INACTIVATE_ACTIVATE"
    [attr.data-qa-id]="'btn-jobs-page-inactivate-activate-jobs'"
    type="button"
    (click)="openJobStatusModal()"
    [title]="!selectedJobIds.length ? 'No Jobs Selected' : ''"
    class="btn btn-secondary pf-btn-borderless">
    <fa-icon [icon]="['far', 'briefcase']"></fa-icon>
    {{isActiveJobs() ? 'Inactivate' : 'Activate'}}
    <span *ngIf="selectedJobIds.length" >
      ({{selectedJobIds.length}})
    </span>
  </button>
  <div
    class="vertical-separator my-2"
    [pfSecuredResource]="[permissions.EMPLOYEES_ADD_EDIT_DELETE, permissions.NEW_PROJECT]">
  </div>
  <button
    [disabled]="!(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length)"
    [attr.data-qa-id]="'btn-jobs-page-clear-selections'"
    type="button"
    (click)="clearSelections()"
    [title]="!(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length) ? 'No Jobs or Pricings Selected' : ''"
    class="btn btn-secondary pf-btn-borderless">
    <fa-icon [icon]="['far', 'times']"></fa-icon>
    Clear Selections
  </button>
</ng-template>


<ng-template #payMarketFilter>
  <div>
    <label>Pay Market:</label>
    <kendo-dropdownlist
      [(ngModel)]="selectedPayMarket"
      [textField]="'Value'"
      [valueField]="'Id'"
      [defaultItem]="{Value:'All Pay Markets', Id: null}"
      [data]="filteredPayMarketOptions"
      (valueChange)="handlePayMarketFilterChanged($event)"
      [filterable]="true"
      (filterChange)="handlePayMarketDropdownFilter($event)"
      [attr.data-qa-id]="'ddm-operator-jobs-page' + payMarketField.SourceName"
      class="k-dropdown-white form-control">
    </kendo-dropdownlist>
  </div>
</ng-template>

<ng-template #structureGradeFilter>
  <div>
    <label>Grade:</label>
    <kendo-dropdownlist
      [(ngModel)]="selectedStructureGrade"
      [textField]="'Value'"
      [valueField]="'Id'"
      [defaultItem]="{Value:'All Grades', Id: null}"
      [data]="filteredStructureGradeNameOptions"
      (valueChange)="handleGradeFilterChanged($event)"
      [filterable]="true"
      (filterChange)="handleStructureGradeNameDropdownFilter($event)"
      [attr.data-qa-id]="'ddm-operator-jobs-page' + structureGradeSearchField.SourceName"
      class="k-dropdown-white form-control">
    </kendo-dropdownlist>
  </div>
</ng-template>

<ng-template #jobStatusFilter let-field="field">
  <kendo-switch
    *ngIf="field"
    style="width:80px;"
    [title]="field.FilterPlaceholder"
    [checked]="field.FilterValue"
    [onLabel]="'Active'"
    [offLabel]="'Inactive'"
    (valueChange)="handleJobStatusFilterChanged(field, $event)"
    (click)="clearFiltersAndSelections()">
  </kendo-switch>
</ng-template>


<pf-modal-form
  [size]="'md'"
  [title]="'Create Project'"
  [primaryButtonText]="'Create'"
  [primaryButtonTextSubmitting]="'Creating'"
  [modalId]="'au-modal-jobs-page-create-project'"
  [submitting]="(creatingProject$ | async).loading"
  [allowDismiss]="!(creatingProject$ | async).loading"
  [isOpen$]="showCreateProjectModal$"
  (onSubmit)="createProject()"
  (onDismiss)="showCreateProjectModal.next(false);">

  <ng-container basic-content>
    The following will be used to create a new project:
    <div>
      &bull; Job Count: {{selectedJobIds.length}}
    </div>
    <div>
      &bull; Pricing Count: {{selectedPricingIds.length}}
    </div>
    <div>
      &bull; Job:Pay Market Associations: {{selectedJobPayMarketCombos.length}}
    </div>
    <div *ngIf="(creatingProject$ | async).loadingError">
      <br>
      <span class="text-danger">
        <b>We encountered a problem creating your project. Please try again or contact your account representative.</b>
      </span>
    </div>
  </ng-container>
</pf-modal-form>

<pf-modal-form
  [size]="'md'"
  [title]="(isActiveJobs() ? 'Inactivate' : 'Activate') + ' Jobs'"
  [primaryButtonText]="(isActiveJobs() ? 'Inactivate' : 'Activate')"
  [primaryButtonTextSubmitting]="isActiveJobs() ? 'Inactivating' : 'Activating'"
  [modalId]="'au-modal-jobs-page-inactivate-activate-jobs'"
  [submitting]="(changingJobStatus$ | async).loading"
  [allowDismiss]="!(changingJobStatus$ | async).loading"
  [isOpen$]="showJobStatusModal$"
  (onSubmit)="changingJobStatus()"
  (onDismiss)="showJobStatusModal.next(false)">

  <ng-container basic-content>
    You are about to make {{selectedJobIds.length}} job{{selectedJobIds.length > 1 ? 's' : ''}}
    {{isActiveJobs() ? 'Inactive' : 'Active'}}.
    <br><br>
    By doing so, {{selectedJobIds.length > 1 ? 'they' : 'it'}} will become {{isActiveJobs() ? 'unavailable' : 'available'}}
    for use throughout the system. Would you like to continue?
    <div *ngIf="(changingJobStatus$ | async).loadingError">
      <br>
      <span class="text-danger">
        <b>
          We encountered a problem {{isActiveJobs() ? 'Inactivating' : 'Activating'}} the jobs you selected.
          Please try again or contact your account representative.
        </b>
      </span>
    </div>
  </ng-container>
</pf-modal-form>

<pf-modal-form
  [size]="'md'"
  [title]="'Delete a Job - ' + jobNameToDelete"
  [primaryButtonText]="'Delete'"
  [primaryButtonClass]="'btn-danger'"
  [primaryButtonTextSubmitting]="'Deleting'"
  [modalId]="'au-modal-jobs-page-delete-a-job'"
  [submitting]="(deletingJob$ | async).loading"
  [allowDismiss]="!(deletingJob$ | async).loading"
  [isOpen$]="showDeleteJobModal$"
  (onSubmit)="deleteJob()"
  (onDismiss)="showDeleteJobModal.next(false)">

  <ng-container basic-content>
    You are about to delete the <b>{{jobNameToDelete}}</b> job and all of the associated pricings, slotted job matches, structures and employees.
    <br><br>
    This cannot be undone. Are you sure?
    <div *ngIf="deletingJob$ | async as deletingJob">
      <div *ngIf="deletingJob.loadingError">
        <br>
        <span class="text-danger">
          <b *ngIf="deletingJob.loadingErrorResponse.status === 409">
            {{deletingJob.loadingErrorResponse.error.value}}
          </b>
          <b *ngIf="deletingJob.loadingErrorResponse.status !== 409">
            We encountered a problem deleting your job. Please try again or contact your account representative.
          </b>
        </span>
      </div>
    </div>
  </ng-container>
</pf-modal-form>

<pf-modal-form
  [size]="'lg'"
  [title]="'Matches'"
  [submitEnabled]="false"
  [showSubmit]="false"
  [secondaryButtonText]="'Close'"
  [centered]="true"
  [showSpinner]="true"
  [modalId]="'au-modal-jobs-page-matches'"
  [allowDismiss]="true"
  [isOpen$]="showSurveyParticipationModal$"
  (onDismiss)="showSurveyParticipationModal.next(false)">
  <ng-container basic-content>
    <div class="survey-participation-modal-container">
      <pf-survey-participation-page *ngIf="matchJobId && showSurveyParticipationModal$ | async" [jobId]= "matchJobId" ></pf-survey-participation-page>
    </div>
  </ng-container>

</pf-modal-form>

<pf-modal-form
  [size]="'lg'"
  [showFooter]="false"
  [modalId]="'au-modal-jobs-page-multi-match'"
  [isOpen$]="showModifyingPricings$"
  (onDismiss)="showModifyingPricings.next(false)">
  <!--TODO: The multi match page itself handles the UI layout. This is for PoC/Initial work for modifying pricings -->
  <ng-container basic-content>
    <pf-async-container [loading]="(pricingsToModify$ | async)?.loading">
      <div class="multi-match-container">
        <div class="row">
          <div class="col-3">
            Filters
          </div>
          <div class="col-6">
            Results
          </div>
          <div class="col-3">
            <div *ngFor="let pricing of (pricingsToModify$ | async)?.obj" [title]="pricing.Paymarket">
              {{pricing.Job.Title}} ({{pricing.Job.Code}})
              <br />
              Show Cuts ({{pricing.DataCutsCount}}) | Show Job Detail
            </div>
          </div>
        </div>
      </div>
    </pf-async-container>
  </ng-container>
</pf-modal-form>

<pf-job-management
  [showModal$]="showJobManagementModal$"
  [jobId]="editingJobId"
  (cancelChanges)="toggleJobManagmentModal(false)"
  (saveSuccess)="toggleJobManagmentModal(false)">
</pf-job-management>
