<pf-data-grid
  [pageViewId]="pageViewId"
  [title]="getPageTitle(company$ | async)"
  [navigationURL]="'/client/dashboard'"
  [selectionField]="'CompanyJob_ID'"
  [gridGlobalActionsTemplate]="gridGlobalActions"
  [gridGlobalFiltersTemplates]="globalFilterTemplates"
  [gridActionsTemplate]="gridActions"
  [columnTemplates]="colTemplates"
  [filterPanelTemplates]="filterTemplates"
  [inboundFilters]="filters"
  [showFilterChooser]="true"
  [allowExport]="false"
  [defaultSort]="defaultSort"
  [enableSelection]="true"
  [splitViewTemplate]="jobsDetails"
  [noRecordsFound]="'No jobs available. Please change your search criteria or add a new job.'"
  [showActionBar]="true">
</pf-data-grid>

<ng-template #jobTitleColumn let-dataRow="dataRow" let-hover="hover">

  <div class="d-flex">
    <div>{{dataRow['CompanyJobs_Job_Title']}}</div>
    <div
      *ngIf="!(selectedRecordId$ | async)"
      [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
      class="ml-auto">

      <div ngbDropdown #jobsActionsMenu="ngbDropdown" class="d-inline-block k-grid-ignore-click" placement="bottom-right">
        <button
          ngbDropdownToggle
          [attr.data-qa-id]="'btn-jobs-page-inline-actions-' + dataRow['CompanyJobs_CompanyJob_ID']"
          class="btn btn-secondary btn-sm hide-dropdown-arrow inline-menu-btn">
          <fa-icon icon="ellipsis-h"></fa-icon>
        </button>
        <div ngbDropdownMenu class="dropdown-menu dropdown-menu-left">
          <button
            [attr.data-qa-id]="'btn-jobs-page-edit-job-' + dataRow['CompanyJobs_CompanyJob_ID']"
            [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
            class="dropdown-item"
            (click)="editingJobId = dataRow['CompanyJobs_CompanyJob_ID']; showJobEditModal=true;">
            <fa-icon icon="edit" class="pr-2" [fixedWidth]="true"></fa-icon> Edit Job
          </button>
          <button
            [attr.data-qa-id]="'btn-jobs-page-delete-job-' + dataRow['CompanyJobs_CompanyJob_ID']"
            [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
            class="dropdown-item"
            (click)="openDeleteJobModal(dataRow['CompanyJobs_CompanyJob_ID'], dataRow['CompanyJobs_Job_Title'])">
            <fa-icon icon="trash-alt" class="pr-2" [fixedWidth]="true"></fa-icon> Delete Job
          </button>
        </div>
      </div>
    </div>
  </div>

</ng-template>

<ng-template #jobStatusColumn let-dataRow="dataRow">
  {{dataRow['CompanyJobs_JobStatus'] ? 'Active' : 'Inactive'}}
</ng-template>

<ng-template #hasPeerDataColumn let-dataRow="dataRow">
  <fa-icon icon="exchange-alt" *ngIf="dataRow['CompanyJobs_Exchange_ID']"></fa-icon>
</ng-template>

<ng-template #jobsDetails let-splitViewEmitter="splitViewEmitter" let-splitViewFilters="splitViewFilters">
  <pf-jobs-details
    [jobDetailsFilters]="splitViewFilters"
    (onClose)="splitViewEmitter.emit('close')">
  </pf-jobs-details>
</ng-template>

<ng-template #gridGlobalActions>
  <button
    [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
    [attr.data-qa-id]="'btn-jobs-page-new-job'"
    type="button"
    title="Add Job"
    (click)="showJobEditModal = true"
    class="btn btn-primary">
    New Job
  </button>
  <button [disabled]="!isActiveJobs() || !(selectedJobIds.length || selectedPricingIds.length)"
          type="button" title="Export" id="jobs-page-export-popover-btn" class="btn btn-secondary"
          data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
          placement="bottom-right" popoverTitle="Choose Export Type" [ngbPopover]="exportList"
          [autoClose]="'outside'" [attr.data-qa-id]="'btn-jobs-page-export'"
  >
    <fa-icon icon="download"></fa-icon>
  </button>

  <!--
  <button [disabled]="disabled || (savedViews && !savedViews.length)" [title]="(savedViews && !savedViews.length) ? 'No Saved Filters' : 'Saved Filters'"
    type="button" id="filter-popover-btn" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true"
    aria-expanded="false" placement="bottom-right" #p="ngbPopover" popoverTitle="Saved Filters" [ngbPopover]="popContent"
    [autoClose]="'outside'" [attr.data-qa-id]="'btn-saved-filters'" (hidden)="cancelDelete()">
  </button>
  -->



  <!--<button
    [disabled]="!isActiveJobs() || !(selectedJobIds.length || selectedPricingIds.length)"
    (click)="exportPricings()"
    class="btn btn-primary">
    Export Placeholder
  </button>-->
</ng-template>

<ng-template #gridActions>
  <button
    [disabled]="!isActiveJobs() || !(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length)"
    [pfSecuredResource]="permissions.NEW_PROJECT"
    [attr.data-qa-id]="'btn-jobs-page-add-to-project'"
    type="button"
    (click)="toggleAddToProjectModal(true)"
    [title]="!(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length) ? 'No Jobs or Pricings Selected' : ''"
    class="btn btn-link">
    Add to Project
    <span *ngIf="selectedJobIds.length + selectedPricingIds.length + selectedJobPayMarketCombos.length > 0 && isActiveJobs()">
      ({{selectedJobIds.length + selectedPricingIds.length + selectedJobPayMarketCombos.length}})
    </span>
  </button>
  <button
    [disabled]="!(selectedJobIds.length)"
    [pfSecuredResource]="permissions.JOBS_INACTIVATE_ACTIVATE"
    [attr.data-qa-id]="'btn-jobs-page-inactivate-activate-jobs'"
    type="button"
    (click)="toggleJobStatusModal(true)"
    [title]="!selectedJobIds.length ? 'No Jobs Selected' : ''"
    class="btn btn-link">
    {{isActiveJobs() ? 'Inactivate' : 'Activate'}}
    <span *ngIf="selectedJobIds.length">
      ({{selectedJobIds.length}})
    </span>
  </button>
  <button
    [disabled]="!(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length)"
    [attr.data-qa-id]="'btn-jobs-page-clear-selections'"
    type="button"
    (click)="clearSelections()"
    [title]="!(selectedJobIds.length || selectedPricingIds.length || selectedJobPayMarketCombos.length) ? 'No Jobs or Pricings Selected' : ''"
    class="btn btn-link">
    Clear Selections
  </button>
</ng-template>

<pf-modal-form
  [size]="'md'"
  [title]="'Add to Project'"
  [primaryButtonText]="'Add'"
  [primaryButtonTextSubmitting]="'Adding'"
  [modalId]="'au-modal-jobs-page-add-to-project'"
  [submitting]="(addingToProject$ | async).loading"
  [allowDismiss]="!(addingToProject$ | async).loading"
  [isOpen$]="showAddToProjectModal$"
  (onSubmit)="addToProject()"
  (onDismiss)="toggleAddToProjectModal(false)">

  <ng-container basic-content>
    The following will be added to a new Project:
    <div>
      &bull; Job Count: {{selectedJobIds.length}}
    </div>
    <div>
      &bull; Pricing Count: {{selectedPricingIds.length}}
    </div>
    <div>
      &bull; Job:Pay Market Associations: {{selectedJobPayMarketCombos.length}}
    </div>
    <div *ngIf="(addingToProject$ | async).loadingError">
      <br>
      <span class="text-danger">
        <b>We encountered a problem adding your selections to a project. Please try again or contact your account representative.</b>
      </span>
    </div>
  </ng-container>
</pf-modal-form>

<pf-modal-form
  [size]="'md'"
  [title]="(isActiveJobs() ? 'Inactivate' : 'Activate') + ' Jobs'"
  [primaryButtonText]="(isActiveJobs() ? 'Inactivate' : 'Activate')"
  [primaryButtonTextSubmitting]="isActiveJobs() ? 'Inactivating' : 'Activating'"
  [modalId]="'au-modal-jobs-page-inactivate-activate-jobs'"
  [submitting]="(changingJobStatus$ | async).loading"
  [allowDismiss]="!(changingJobStatus$ | async).loading"
  [isOpen$]="showJobStatusModal$"
  (onSubmit)="changingJobStatus()"
  (onDismiss)="toggleJobStatusModal(false)">

  <ng-container basic-content>
    You are about to make {{selectedJobIds.length}} job{{selectedJobIds.length > 1 ? 's' : ''}}
    {{isActiveJobs() ? 'Inactive' : 'Active'}}.
    <br><br>
    By doing so, {{selectedJobIds.length > 1 ? 'they' : 'it'}} will become {{isActiveJobs() ? 'unavailable' : 'available'}}
    for use throughout the system. Would you like to continue?
    <div *ngIf="(changingJobStatus$ | async).loadingError">
      <br>
      <span class="text-danger">
        <b>
          We encountered a problem {{isActiveJobs() ? 'Inactivating' : 'Activating'}} the jobs you selected.
          Please try again or contact your account representative.
        </b>
      </span>
    </div>
  </ng-container>
</pf-modal-form>

<pf-modal-form
  [size]="'md'"
  [title]="'Delete a Job - ' + jobNameToDelete"
  [primaryButtonText]="'Delete'"
  [primaryButtonClass]="'btn-danger'"
  [primaryButtonTextSubmitting]="'Deleting'"
  [modalId]="'au-modal-jobs-page-delete-a-job'"
  [submitting]="(deletingJob$ | async).loading"
  [allowDismiss]="!(deletingJob$ | async).loading"
  [isOpen$]="showDeleteJobModal$"
  (onSubmit)="deleteJob()"
  (onDismiss)="closeDeleteJobModal()">

  <ng-container basic-content>
    You are about to delete the <b>{{jobNameToDelete}}</b> job and all of the associated pricings, slotted job matches, structures and employees.
    <br><br>
    This cannot be undone. Are you sure?
    <div *ngIf="deletingJob$ | async as deletingJob">
      <div *ngIf="deletingJob.loadingError">
        <br>
        <span class="text-danger">
          <b *ngIf="deletingJob.loadingErrorResponse.status === 409">
            {{deletingJob.loadingErrorResponse.error.value}}
          </b>
          <b *ngIf="deletingJob.loadingErrorResponse.status !== 409">
            We encountered a problem deleting your job. Please try again or contact your account representative.
          </b>
        </span>
      </div>
    </div>
  </ng-container>
</pf-modal-form>

<pf-job-management
  [showJobModal]="showJobEditModal"
  [jobId]="editingJobId"
  (cancelChanges)="closeJobManagmentModal()"
  (saveSuccess)="closeJobManagmentModal()">
</pf-job-management>

<ng-template #payMarketFilter>
  <div>
    <label>Pay Market:</label>
    <kendo-dropdownlist
      [(ngModel)]="selectedPayMarket"
      [textField]="'Value'"
      [valueField]="'Id'"
      [defaultItem]="{Value:'All Pay Markets', Id: null}"
      [data]="filteredPayMarketOptions"
      (valueChange)="handlePayMarketFilterChanged($event)"
      [filterable]="true"
      (filterChange)="handlePayMarketDropdownFilter($event)"
      [attr.data-qa-id]="'ddm-operator-jobs-page' + payMarketField.SourceName"
      class="k-dropdown-white form-control">
    </kendo-dropdownlist>
  </div>
</ng-template>

<ng-template #structureGradeFilter>
  <div>
    <label>Grade:</label>
    <kendo-dropdownlist
      [(ngModel)]="selectedStructureGrade"
      [textField]="'Value'"
      [valueField]="'Id'"
      [defaultItem]="{Value:'All Grades', Id: null}"
      [data]="filteredStructureGradeNameOptions"
      (valueChange)="handleGradeFilterChanged($event)"
      [filterable]="true"
      (filterChange)="handleStructureGradeNameDropdownFilter($event)"
      [attr.data-qa-id]="'ddm-operator-jobs-page' + structureGradeSearchField.SourceName"
      class="k-dropdown-white form-control">
    </kendo-dropdownlist>
  </div>
</ng-template>

<ng-template #jobStatusFilter let-field="field">
  <kendo-switch
    *ngIf="field"
    style="width:80px;"
    [title]="field.FilterPlaceholder"
    [checked]="field.FilterValue"
    [onLabel]="'Active'"
    [offLabel]="'Inactive'"
    (valueChange)="handleJobStatusFilterChanged(field, $event)"
    (click)="clearFiltersAndSelections()">
  </kendo-switch>
</ng-template>

<ng-template #exportList>
  <div class="popover-body-container">
    <div class="popover-body-content">
      <!--<p>
      <pf-input-debounce [disabled]="viewDeleting || viewNameToBeDeleted" id="filter-search-box" [id]="'filter-chooser-search'" (valueChanged)="(filter = $event)" [placeholderText]="'Search for a Filter...'">
      </pf-input-debounce>
    </p> -->
      <div class="export-popover-divider pl-2">
        System Exports
      </div>

      <div class="list-group">
        <div *ngFor="let opt of exportOptions" class="list-group-item list-group-item-action p-2">
          <div class="row align-items-center">
            <div class="col-8">
              <span>{{opt.Name}}</span>
              <small class="export-desc">{{opt.Description}}</small>
            </div>
            <div class="export-btn-group space-out-children row">
              <div>
                <button *ngIf="opt.ValidExtensions.indexOf('xlsx') > -1" class="btn btn-secondary" (click)="exportPricings(opt, 'xlsx')">
                  <fa-icon fa-icon [icon]="['fal', 'file-excel']"></fa-icon>
                </button>
              </div>
              <div>
                <button *ngIf="opt.ValidExtensions.indexOf('pdf') > -1" class="btn btn-secondary" (click)="exportPricings(opt, 'pdf')">
                  <fa-icon fa-icon [icon]="['fal', 'file-pdf']"></fa-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</ng-template>

<form name="exportForm" method="POST">
  <input type="hidden" name="export-uid" />
  <input type="hidden" name="export-type" />
  <input type="hidden" name="job-ids" />
  <input type="hidden" name="pricing-ids" />
</form>
