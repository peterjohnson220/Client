<pf-data-grid
  [pageViewId]="pageViewId"
  [title]="getPageTitle(company$ | async)"
  [navigationURL]="'/client/dashboard'"
  [selectionField]="'CompanyJob_ID'"
  [gridGlobalActionsTemplate]="gridGlobalActions"
  [gridGlobalFiltersTemplates]="globalFilterTemplates"
  [gridActionsTemplate]="gridActions"
  [columnTemplates]="colTemplates"
  [filterPanelTemplates]="filterTemplates"
  [inboundFilters]="filters"
  [showFilterChooser]="true"
  [allowExport]="false"
  [defaultSort]="defaultSort"
  [enableSelection]="true"
  [splitViewTemplate]="jobsDetails"
  [noRecordsFound]="'No jobs available. Please change your search criteria or add a new job.'"
  [showActionBar]="true">
</pf-data-grid>

<ng-template #jobTitleColumn let-dataRow="dataRow" let-hover="hover">

  <div class="d-flex">
    <div>{{dataRow['CompanyJobs_Job_Title']}}</div>
    <div
      *ngIf="!(selectedRecordId$ | async)"
      [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
      class="ml-auto">

      <div ngbDropdown #jobsActionsMenu="ngbDropdown" class="d-inline-block k-grid-ignore-click" placement="bottom-right">
        <button
          ngbDropdownToggle 
          [attr.data-qa-id]="'btn-jobs-page-inline-actions-' + dataRow['CompanyJobs_CompanyJob_ID']"
          class="btn btn-secondary btn-sm hide-dropdown-arrow inline-menu-btn">
          <fa-icon icon="ellipsis-h"></fa-icon>
        </button>
        <div ngbDropdownMenu class="dropdown-menu dropdown-menu-left">
          <button
            [attr.data-qa-id]="'btn-jobs-page-edit-job-' + dataRow['CompanyJobs_CompanyJob_ID']"
            [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
            class="dropdown-item"
            (click)="editingJobId = dataRow['CompanyJobs_CompanyJob_ID']; showJobEditModal=true;">
            <fa-icon icon="edit" class="pr-2"></fa-icon> Edit Job
          </button>
        </div>
      </div>
    </div>
  </div>
  
</ng-template>

<ng-template #jobStatusColumn let-dataRow="dataRow">
  {{dataRow['CompanyJobs_JobStatus'] ? 'Active' : 'Inactive'}}
</ng-template>

<ng-template #hasPeerDataColumn let-dataRow="dataRow">
  <fa-icon icon="exchange-alt" *ngIf="dataRow['CompanyJobs_Exchange_ID']"></fa-icon>
</ng-template>

<ng-template #jobsDetails let-splitViewEmitter="splitViewEmitter" let-splitViewFilters="splitViewFilters">
  <pf-jobs-details
    [jobDetailsFilters]="splitViewFilters"
    (onClose)="splitViewEmitter.emit('close')">
  </pf-jobs-details>
</ng-template>

<ng-template #gridGlobalActions>
  <button
    [pfSecuredResource]="permissions.JOBS_ADD_EDIT_DELETE"
    [attr.data-qa-id]="'btn-jobs-page-new-job'"
    type="button"
    title="Add Job"
    (click)="showJobEditModal = true"
    class="btn btn-primary">
    New Job
  </button>
</ng-template>

<ng-template #gridActions>
  <button
    [disabled]="!isActiveJobs() || !(selectedJobIds.length || selectedPricingIds.length)"
    [pfSecuredResource]="permissions.NEW_PROJECT"
    [attr.data-qa-id]="'btn-jobs-page-add-to-project'"
    type="button"
    (click)="toggleAddToProjectModal(true)"
    [title]="!(selectedJobIds.length || selectedPricingIds.length) ? 'No Jobs or Pricings Selected' : ''"
    class="btn btn-link">
    Add to Project
    <span *ngIf="selectedJobIds.length + selectedPricingIds.length > 0 && isActiveJobs()">
      ({{selectedJobIds.length + selectedPricingIds.length}})
    </span>
  </button>
  <button
    [disabled]="!(selectedJobIds.length)"
    [pfSecuredResource]="permissions.JOBS_INACTIVATE_ACTIVATE"
    [attr.data-qa-id]="'btn-jobs-page-inactivate-activate-jobs'"
    type="button"
    (click)="toggleJobStatusModal(true)"
    [title]="!selectedJobIds.length ? 'No Jobs Selected' : ''"
    class="btn btn-link">
    {{isActiveJobs() ? 'Inactivate' : 'Activate'}}
    <span *ngIf="selectedJobIds.length">
      ({{selectedJobIds.length}})
    </span>
  </button>
  <button
    [disabled]="!(selectedJobIds.length || selectedPricingIds.length)"
    [attr.data-qa-id]="'btn-jobs-page-clear-selections'"
    type="button"
    (click)="clearSelections()"
    [title]="!(selectedJobIds.length || selectedPricingIds.length) ? 'No Jobs or Pricings Selected' : ''"
    class="btn btn-link">
    Clear Selections
  </button>
</ng-template>

<pf-modal-form
  [size]="'md'"
  [title]="'Add to Project'"
  [primaryButtonText]="'Add'"
  [primaryButtonTextSubmitting]="'Adding'"
  [modalId]="'au-modal-jobs-page-add-to-project'"
  [submitting]="(addingToProject$ | async).loading"
  [allowDismiss]="!(addingToProject$ | async).loading"
  [isOpen$]="showAddToProjectModal$"
  (onSubmit)="addToProject()"
  (onDismiss)="toggleAddToProjectModal(false)">

  <ng-container basic-content>
    The following will be added to a new Project:
    <div>
      Job Count: {{selectedJobIds.length}}
    </div>
    <div>
      Pricing Count: {{selectedPricingIds.length}}
    </div>
    <div *ngIf="(addingToProject$ | async).loadingError">
      <br>
      <span class="text-danger">
        <b>We encountered a problem adding your selections to a project. Please try again or contact your account representative.</b>
      </span>
    </div>
  </ng-container>
</pf-modal-form>

<pf-modal-form
  [size]="'md'"
  [title]="(isActiveJobs() ? 'Inactivate' : 'Activate') + ' Jobs'"
  [primaryButtonText]="(isActiveJobs() ? 'Inactivate' : 'Activate')"
  [primaryButtonTextSubmitting]="isActiveJobs() ? 'Inactivating' : 'Activating'"
  [modalId]="'au-modal-jobs-page-inactivate-activate-jobs'"
  [submitting]="(changingJobStatus$ | async).loading"
  [allowDismiss]="!(changingJobStatus$ | async).loading"
  [isOpen$]="showJobStatusModal$"
  (onSubmit)="changingJobStatus()"
  (onDismiss)="toggleJobStatusModal(false)">

  <ng-container basic-content>
    You are about to make {{selectedJobIds.length}} job{{selectedJobIds.length > 1 ? 's' : ''}}
    {{isActiveJobs() ? 'Inactive' : 'Active'}}.
    <br><br>
    By doing so, {{selectedJobIds.length > 1 ? 'they' : 'it'}} will become {{isActiveJobs() ? 'unavailable' : 'available'}}
    for use throughout the system. Would you like to continue?
    <div *ngIf="(changingJobStatus$ | async).loadingError">
      <br>
      <span class="text-danger">
        <b>
          We encountered a problem {{isActiveJobs() ? 'Inactivating' : 'Activating'}} the jobs you selected.
          Please try again or contact your account representative.
        </b>
      </span>
    </div>
  </ng-container>
</pf-modal-form>

<pf-job-management
  [showJobModal]="showJobEditModal"
  [jobId]="editingJobId"
  (cancelChanges)="closeJobManagmentModal()"
  (saveSuccess)="closeJobManagmentModal()">
</pf-job-management>

<ng-template #payMarketFilter>
  <div>
    <label>Pay Market:</label>
    <kendo-dropdownlist
      [(ngModel)]="selectedPayMarket"
      [textField]="'Value'"
      [valueField]="'Id'"
      [defaultItem]="{Value:'All Pay Markets', Id: null}"
      [data]="filteredPayMarketOptions"
      (valueChange)="handlePayMarketFilterChanged($event)"
      [filterable]="true"
      (filterChange)="handlePayMarketDropdownFilter($event)"
      [attr.data-qa-id]="'ddm-operator-jobs-page' + payMarketField.SourceName"
      class="k-dropdown-white form-control">
    </kendo-dropdownlist>
  </div>
</ng-template>

<ng-template #structureGradeFilter>
  <div>
    <label>Grade:</label>
    <kendo-dropdownlist
      [(ngModel)]="selectedStructureGrade"
      [textField]="'Value'"
      [valueField]="'Id'"
      [defaultItem]="{Value:'All Grades', Id: null}"
      [data]="filteredStructureGradeNameOptions"
      (valueChange)="handleGradeFilterChanged($event)"
      [filterable]="true"
      (filterChange)="handleStructureGradeNameDropdownFilter($event)"
      [attr.data-qa-id]="'ddm-operator-jobs-page' + structureGradeSearchField.SourceName"
      class="k-dropdown-white form-control">
    </kendo-dropdownlist>
  </div>
</ng-template>

<ng-template #jobStatusFilter let-field="field">
  <kendo-switch
    *ngIf="field"
    style="width:80px;"
    [title]="field.FilterPlaceholder"
    [checked]="field.FilterValue"
    [onLabel]="'Active'"
    [offLabel]="'Inactive'"
    (valueChange)="handleJobStatusFilterChanged(field, $event)"
    (click)="clearFiltersAndSelections()">
  </kendo-switch>
</ng-template>
